name: P0 Protection Enforcement
on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]

jobs:
  p0-protection:
    name: "ðŸ›¡ï¸ P0 Business-Critical Test Protection"
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run P0 Protection Gate
      run: |
        echo "ðŸ›¡ï¸ MANDATORY P0 PROTECTION GATE"
        echo "================================="
        echo "P0 tests are BUSINESS-CRITICAL and must pass 100%"
        echo "No exceptions. No deferrals. No compromises."
        echo ""

        python .claudedirector/tools/p0_protection/mandatory_p0_gates.py "CI/CD Pipeline"

    - name: P0 Test Execution
      run: |
        echo "ðŸ§ª Running mandatory P0 test suite..."
        python .claudedirector/tests/p0_enforcement/run_mandatory_p0_tests.py

    - name: P0 Results Validation
      run: |
        echo "ðŸ“Š Validating P0 results..."
        # Extract results dynamically instead of hardcoded 41/41
        result=$(python .claudedirector/tests/p0_enforcement/run_mandatory_p0_tests.py 2>&1 | grep "SUCCESS RATE" || true)

        # Extract the actual test counts dynamically (e.g., "40/40 tests passing")
        if echo "$result" | grep -q "tests passing (100%)"; then
          test_count=$(echo "$result" | grep -o '[0-9]\+/[0-9]\+ tests passing' | head -1)
          echo "âœ… P0 PROTECTION: All $test_count business-critical tests passing"
        else
          echo "ðŸš¨ P0 PROTECTION FAILURE: Not all P0 tests passing"
          echo "âŒ BLOCKING DEPLOYMENT: P0 tests are business-critical"
          echo "ðŸ” Test output: $result"
          exit 1
        fi

    - name: Success Notification
      if: success()
      run: |
        echo "ðŸŽ‰ P0 PROTECTION PASSED"
        # Get dynamic test count for success message
        test_count=$(python .claudedirector/tests/p0_enforcement/run_mandatory_p0_tests.py 2>&1 | grep -o '[0-9]\+/[0-9]\+ tests passing' | head -1)
        echo "âœ… All $test_count business-critical tests verified"
        echo "ðŸŸ¢ Deployment approved by P0 protection system"
